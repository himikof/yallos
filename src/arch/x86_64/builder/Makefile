# arch/x86/builder: x86 image builder

# Magic header, do not touch
sp :=
sp +=
_walk = $(if $1,$(wildcard /$(subst $(sp),/,$1)/$2) $(call _walk,$(wordlist 2,$(words $1),x $1),$2))
_find = $(firstword $(call _walk,$(strip $(subst /, ,$1)),$2))
_ROOT ?= $(patsubst %/root.mk,%,$(call _find,$(CURDIR),root.mk))
include $(_ROOT)/root.mk
include $(_ROOT)/prefix.mk
# End of magic

$(call DEPENDS_ON,kernel)

$(call local_target,image)_TDEPS += kernel_preimage
$(call local_target,image)_LDSCRIPT = $(_MODULE_PATH)/kernel.ld
$(call add_executable,image,)

QUIET_SIZE = @echo 'SIZE '$(call local_build,$^) &&
SILENT_SIZE = @

$(call local_target,size)_OUTPUT := size.inc
$(call add_custom,size,$($(call local_target,image)_PATH))

ifneq ($($(_MODULE_NAME)_DEFINED),T)
$($(call local_target,size)_PATH) : $($(call local_target,image)_PATH) 
	$($(MODE)SIZE)echo "/* This file was autogenerated by make */" > $@
	$(Q)echo "KERN_SIZE = $(shell $(STAT) $^ -c '%s')" >> $@
endif

TARGETS = image

# Magic footer, do not touch
include $(_ROOT)/suffix.mk
